---
title: Self-hosting
description: Пошаговая инструкция по развёртыванию MPFlow на своём сервере или локально
---

# Self-hosting

MPFlow распространяется как Docker-образ. Для работы нужен **PostgreSQL** — поднимается автоматически из `docker-compose.yml`.

## Требования

- Docker 24+ и Docker Compose v2
- 2 GB RAM (минимум)
- Node.js 20+ (только для локальной разработки без Docker)

## Быстрый старт

### 1. Скачать compose-файл

```bash
curl -O https://raw.githubusercontent.com/teploe-odealko/mp-flow/main/docker-compose.yml
```

### 2. Создать файл окружения

```bash
cat > .env << 'EOF'
DB_PASSWORD=ваш_пароль_для_бд
COOKIE_SECRET=сгенерируйте_openssl_rand_base64_32
EOF
```

Сгенерировать секрет:

```bash
openssl rand -base64 32  # для COOKIE_SECRET
```

### 3. Запустить

```bash
docker compose up -d
```

Ждём пока сервисы стартуют (~30 секунд на первый запуск):

```bash
docker compose logs -f admin
```

Когда увидите `Admin server running` — система готова.

### 4. Войти в админку

Откройте в браузере:

```
http://localhost:3000
```

Авторизация — через Logto OIDC (если настроен) или напрямую.

## Обновление

```bash
docker compose pull
docker compose up -d
```

## Локальная разработка (без Docker)

### 1. Клонировать репозиторий

```bash
git clone https://github.com/teploe-odealko/mp-flow.git
cd mp-flow/admin
```

### 2. Установить зависимости

```bash
npm install
```

### 3. Настроить `.env`

Создайте `admin/.env`:

```bash
DATABASE_URL=postgresql://mpflow:mpflow@localhost:5432/mpflow
COOKIE_SECRET=dev-secret
```

### 4. Запустить PostgreSQL

```bash
docker run -d --name mpflow-postgres \
  -e POSTGRES_USER=mpflow \
  -e POSTGRES_PASSWORD=mpflow \
  -e POSTGRES_DB=mpflow \
  -p 5432:5432 \
  postgres:17-alpine
```

### 5. Применить миграции

```bash
npm run db:migrate
```

### 6. Запустить в dev-режиме

```bash
npm run dev
```

Админка будет доступна по адресу `http://localhost:5173` (клиент) с прокси на API `http://localhost:3000`.

## Переменные окружения

### Self-hosted (Docker)

| Переменная | Обязательная | Описание |
|---|---|---|
| `DB_PASSWORD` | Да | Пароль PostgreSQL (используется в docker-compose) |
| `COOKIE_SECRET` | Да | Секрет для cookies. Генерируйте: `openssl rand -base64 32` |
| `PORT` | Нет | Порт для доступа к админке. По умолчанию: `3000` |

### Локальная разработка

| Переменная | Обязательная | Описание |
|---|---|---|
| `DATABASE_URL` | Да | PostgreSQL connection string |
| `COOKIE_SECRET` | Нет | Секрет для cookies (по умолчанию dev-значение) |
| `LOGTO_ENDPOINT` | Нет | URL Logto для OIDC авторизации |
| `LOGTO_SPA_APP_ID` | Нет | App ID Logto SPA приложения |

## Архитектура

```
┌─────────────────────────────────┐
│   Браузер                       │
│   http://localhost:3000         │
└────────────┬────────────────────┘
             │
┌────────────▼────────────────────┐
│   MPFlow Admin (Node.js)       │
│   - Hono API (:3000)          │
│   - React SPA (встроена)      │
│   - Плагины (Ozon)            │
├─────────────────────────────────┤
│   Модули:                       │
│   - master-card (каталог)      │
│   - supplier-order (закупки)   │
│   - finance (транзакции)       │
│   - sale (продажи)             │
└──────┬──────────────────────────┘
       │
┌──────▼──────┐
│ PostgreSQL  │
│ :5432       │
└─────────────┘
```

## Troubleshooting

### Сервер не стартует — ошибки подключения к БД

Проверьте, что PostgreSQL доступен и работает:

```bash
docker compose exec postgres pg_isready -U mpflow -d mpflow
```

### Health check не проходит

Проверьте логи:

```bash
docker compose logs admin
```

И убедитесь что API отвечает:

```bash
curl http://localhost:3000/api/health
```
