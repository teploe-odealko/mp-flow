---
title: Self-hosting
description: Пошаговая инструкция по развёртыванию MPFlow на своём сервере или локально
---

# Self-hosting

MPFlow распространяется как Docker-образ. Для работы нужны **PostgreSQL** и **Redis** — оба поднимаются автоматически из `docker-compose.yml`.

## Требования

- Docker 24+ и Docker Compose v2
- 2 GB RAM (минимум)
- Node.js 20+ (только для локальной разработки без Docker)

## Быстрый старт

### 1. Скачать compose-файл

```bash
curl -O https://raw.githubusercontent.com/teploe-odealko/mp-flow/main/docker-compose.yml
```

### 2. Создать файл окружения

```bash
cat > .env << 'EOF'
MEDUSA_DB_PASSWORD=ваш_пароль_для_бд
COOKIE_SECRET=сгенерируйте_openssl_rand_base64_32
JWT_SECRET=сгенерируйте_openssl_rand_base64_32
EOF
```

Сгенерировать секреты:

```bash
openssl rand -base64 32  # для COOKIE_SECRET
openssl rand -base64 32  # для JWT_SECRET
```

### 3. Запустить

```bash
docker compose up -d
```

Ждём пока сервисы стартуют (~60 секунд на первый запуск — миграции БД запускаются автоматически):

```bash
docker compose logs -f medusa
```

Когда увидите `Medusa server started` — система готова.

### 4. Создать админ-пользователя

```bash
docker compose exec medusa npx medusa user -e admin@example.com -p ваш_пароль
```

### 5. Войти в админку

Откройте в браузере:

```
http://localhost:9000/app
```

Авторизуйтесь с email и паролем, заданными на предыдущем шаге.

## Обновление

```bash
docker compose pull
docker compose up -d
```

Миграции БД применяются автоматически при старте контейнера.

## Локальная разработка (без Docker)

Для разработки удобнее запускать только инфраструктуру в Docker, а Medusa — нативно.

### 1. Клонировать репозиторий

```bash
git clone https://github.com/teploe-odealko/mp-flow.git
cd mp-flow/medusa
```

### 2. Поднять PostgreSQL и Redis

```bash
docker compose up -d
```

Это запустит:
- PostgreSQL на порту **5433** (user: `medusa`, password: `medusa123`, db: `mpflow_medusa`)
- Redis на порту **6380**

### 3. Установить зависимости и собрать плагины

```bash
npm install
```

MPFlow включает плагин Ozon — его нужно собрать перед первым запуском:

```bash
# Собрать ozon-плагин
cd plugins/ozon && npm install && npx medusa plugin:build && cd ../..

# Слинковать в node_modules
rm -rf node_modules/mpflow-plugin-ozon
mkdir -p node_modules/mpflow-plugin-ozon
cp plugins/ozon/package.json node_modules/mpflow-plugin-ozon/
cp -R plugins/ozon/.medusa node_modules/mpflow-plugin-ozon/
```

### 4. Создать `.env` для Medusa

Создайте `medusa/.env`:

```bash
DATABASE_URL=postgresql://medusa:medusa123@localhost:5433/mpflow_medusa
REDIS_URL=redis://localhost:6380
```

### 5. Применить миграции и создать пользователя

```bash
npx medusa db:migrate
npx medusa user -e admin@example.com -p your_password
```

### 6. Запустить в dev-режиме

```bash
npx medusa develop
```

Админка будет доступна по адресу `http://localhost:9000/app`.

## Переменные окружения

### Self-hosted (Docker)

| Переменная | Обязательная | Описание |
|---|---|---|
| `MEDUSA_DB_PASSWORD` | Да | Пароль PostgreSQL (используется в docker-compose) |
| `COOKIE_SECRET` | Да | Секрет для cookies. Генерируйте: `openssl rand -base64 32` |
| `JWT_SECRET` | Да | Секрет для JWT. Генерируйте: `openssl rand -base64 32` |
| `PORT` | Нет | Порт для доступа к админке. По умолчанию: `9000` |

### Локальная разработка

| Переменная | Обязательная | Описание |
|---|---|---|
| `DATABASE_URL` | Да | PostgreSQL connection string |
| `REDIS_URL` | Да | Redis connection string |
| `STORE_CORS` | Нет | CORS для store API |
| `ADMIN_CORS` | Нет | CORS для admin API |
| `AUTH_CORS` | Нет | CORS для auth API |
| `MEDUSA_BACKEND_URL` | Нет | Публичный URL бэкенда (для admin UI за reverse proxy) |

## Архитектура

```
┌─────────────────────────────────┐
│   Браузер                       │
│   http://localhost:9000/app     │
└────────────┬────────────────────┘
             │
┌────────────▼────────────────────┐
│   Medusa v2 (Node.js)          │
│   - Backend API (:9000)        │
│   - Admin UI (встроена)        │
│   - Плагины                    │
├─────────────────────────────────┤
│   Модули:                       │
│   - master-card (каталог)      │
│   - supplier-order (закупки)   │
│   - finance (транзакции)       │
│   - sale (продажи)             │
└──────┬──────────────┬───────────┘
       │              │
┌──────▼──────┐ ┌─────▼─────┐
│ PostgreSQL  │ │   Redis   │
│ :5432       │ │   :6379   │
└─────────────┘ └───────────┘
```

## Troubleshooting

### Medusa не стартует — ошибки миграции

Проверьте, что PostgreSQL доступен и работает:

```bash
docker compose exec postgres pg_isready -U medusa -d mpflow_medusa
```

### Не могу зайти в админку

Убедитесь, что создали пользователя:

```bash
docker compose exec medusa npx medusa user -e admin@example.com -p your_password
```

### Admin UI не загружается (белый экран)

Проверьте, что `MEDUSA_BACKEND_URL` совпадает с URL, по которому вы открываете админку. Для локального доступа через `localhost:9000` можно оставить пустым.
